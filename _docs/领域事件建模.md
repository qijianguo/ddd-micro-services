# 领域事件建模

## 事件风暴
* 提出者：Alberto Brandolini
* 形式：工作坊
### 理解事件风暴
事件风暴以事件为驱动力，是基于事件是一种**因果关系**。

识别和理解事件：
* 产生这一**事件**的原因
* 为什么要响应此**事件**

不同角色对事件有不同的理解：
* 业务人员：事件前后的业务是什么，产生了什么样的业务流程
* 技术人员：是什么触发了事件消息，当事件触发后谁来订阅和处理时间
* 管理人员：事件导致的重要结果是什么，是否会影响到管理和运营
 
事件的角色：
* 用户：用户执行一个业务活动，触发一个事件
* 策略：一个定时条件形成一条业务规则，当定时条件满足时会触发一个事件
* 伴生系统：由外部系统触发的一个事件
* 前置条件：一个事件成为另一个事件的因

### 事件风暴的两个层次
Alberto Brandolini将事件风暴划分为两个层次。

#### 探索业务全景
在工作坊过程中，将主要精力用于识别业务流程中的**领域事件**，可以认为是宏观级别的事件风暴，目的是**探索业务全景（big picture exploration）**。
帮助团队识别**事件、热点、参与的角色**。
大致过程：
* 识别全景事件流
* 标记时间轴的关键时间点，作为划分领域边界和限界上下文的依据
* 基于事件表达的业务概念，确定子领域和限界上下文
* 将事件流划分为多个阶段

事件风暴标记：
* 事件（event）：橙色即时贴
* 警告信息（alert）：粉红色即时贴
* 用户（user）：黄色小即时贴即时贴
* 策略（policy）：紫色小即时贴
* 伴生系统：浅粉色小即时贴

#### 领域分析建模

##### 1、决策命令
Alberto Brandolini将命令称为**决策命令（decision command）**。
命令（Command）触发事件，命令是事件发生的“因”，因此决策命令与事件是一一对应的，决策命令通常用“动词短语组成”，

事件风暴标记：
* 决策命令（decision command）：蓝色即时贴

##### 2、写模型（write model）
状态发生变化了的目标对象，正是写模型状态的变更才导致了事件的发生（*事件的一大特征*）。

事件风暴标记：
* 写模型（write model）：黄色即时贴

写模型状态的3种形式：
* 从无到有创建新的写模型对象
> xxxCreated事件
* 修改了写模型对象的属性
> xxxUpdated或xxxCanceled事件
* 从有到无删除了写模型对象
> xxxDeleted或xxxRemoved事件（*并非一定是物理删除*）

##### 3、读模型（read model）
业务场景为角色提供的信息在事件风暴中称为**读模型**，即由角色通过读（查询）操作得到。

事件风暴标记：
* 读模型（read model）：绿色即时贴

##### 4、事件风暴的领域模型 

领域分析建模过程：
* 通过事件反向驱动出决策命令
> 将事件的过去时态转换为动词形式
* 根据时间状态变更的目标确定写模型
> 一个事件只有一个写模型，如果存在多个写模型，说明写模型之间存在聚合关系，即遗漏了写模型对应的事件
* 综合确定读模型
> 从角色角度思考决策命令的执行，如果写模型的状态发生变化，需要提供哪些读模型。写模型与读模型的关系：1：0..n

### 事件风暴与建模范式
事件风暴识别确认了由**事件、决策命令、写模式、读模式**构成的领域分析模型之后，就可根据建模范式的不同，将其映射为不同的领域模型设计要素。

映射关系：
* 写模式：可以映射为一个聚合的聚合根实体
* 读模式：结合业务场景确定是实体、值对象还是聚合根实体
* 事件：建模为领域事件
* 决策命令：通常被定义为聚合根实体的领域行为，执行了改变其状态的业务逻辑

## 事件溯源模式（event sourcing）
事件溯源模式是为事件建模范式提供的设计模式。在事件溯源模式中，领域事件和聚合是核心要素。
即对聚合生命周期的管理

事件溯源模式的两个关键原则：
* 聚合的每次状态变化，都是一个事件的发生
* 事件是不可变的，以追加的方式记录事件，形成事件日志

#### 领域事件的定义

事件存储（event store）：持久化一系列事件。

事件存储会建立一张事件表，属性有`事件id`，`事件类型`，`聚合id`，`聚合类型`，`事件内容`，`发生时的时间戳` 

#### 聚合的创建与更新

实现时间溯源需要的操作：
* 

## 事件驱动架构
若选择事件驱动模型，应优先考虑限界上下文之间的协作遵循事件驱动架构风格

### 事件驱动架构风格（event-driven architecture）
事件驱动架构风格是一种以事件为媒介、实现组件或服务之间最大松耦合的架构风格。

限界上下文之间采用**发布者/订阅者**模式，事件消息通过**事件总线**传递。

Sam Newman认为限界上下文协作有两种风格：
* 编排（orchestration）
> 将一个限界上下文的应用服务作为中心控制器，用来协调其他多个限界上下文之间的协作
* 协同协作（choreography）：
> 采用发布事件和订阅事件的方式，主服务以异步方式发布事件到事件总线，与之相关的限界上下文通过订阅该事件各自处理自己的业务。

事件驱动架构采用了**协同协作风格**。

### 引入事件流
一个纯粹的事件驱动架构需要将所有限界上下文参与协作的业务场景都设计为**发布订阅事件**的异步协作模式。

引入事件流，在当前限界上下文中缓存和同步本该属于上游限界上下文提供的数据，将原本需要跨限界上下文的查询操作改为本地查询操作。 
